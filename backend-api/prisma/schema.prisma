generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url       = env("DATABASE_URL")
}

// =======================================================
//                       MODELOS BASE
// =======================================================

model area {
  id_area       Int         @id @default(autoincrement()) @map("id_area")
  nombre_area   String      @unique @db.VarChar(100)
  descripcion   String?     @db.VarChar(255)

  // Relaciones
  usuarios      usuario[]
  tickets       ticket[]
  categorias    categoria[]
  // Relaciones para Solicitud de Cambio de Área
  solicitudes_origen    solicitud_cambio_area[] @relation("AreaOrigen")
  solicitudes_destino   solicitud_cambio_area[] @relation("AreaDestino")
}

model rol {
  id_rol        Int           @id @default(autoincrement()) @map("id_rol")
  nombre_rol    String      @unique @db.VarChar(50)
  descripcion   String?     @db.VarChar(255)

  // Relaciones
  usuarios      usuario[]
  roles_permisos rol_permiso[]
}

model usuario {
  id_usuario            Int         @id @default(autoincrement()) @map("id_usuario")
  nombre                String      @db.VarChar(100)
  apellido              String      @db.VarChar(100)
  email                 String      @unique @db.VarChar(150)
  password              String      @db.VarChar(255)
  activo                Boolean     @default(true) @db.TinyInt
  fecha_registro        DateTime    @default(now()) @db.Timestamp(0)

  // Claves Foráneas
  id_rol                Int         @map("id_rol")
  id_area               Int?        @map("id_area")

  // Relaciones
  rol                   rol         @relation(fields: [id_rol], references: [id_rol])
  area                  area?       @relation(fields: [id_area], references: [id_area])

  refresh_tokens        refresh_token[]

  tickets_creados       ticket[]    @relation("Creador")
  tickets_responsable   ticket[]    @relation("Responsable")
  comentarios           comentario[]
  historial_movimientos historial_ticket[]

  // Nuevas Relaciones para el nuevo flujo
  liberaciones          liberacion_ticket[]
  solicitudes_creadas   solicitud_cambio_area[] @relation("Solicitante")
  solicitudes_aprobadas solicitud_cambio_area[] @relation("Aprobador")
}

// NUEVO MODELO PARA MULTI-SESIÓN
model refresh_token {
  id_token      Int      @id @default(autoincrement())
  token         String   @db.Text
  // Nota: MySQL no permite @unique en TEXT sin longitud prefijada. Mejor usar VarChar o solo lógica de negocio.
  // Para simplificar y compatibilidad, usaremos String normal (Text) y búsquedas directas.
  
  fecha_creacion DateTime @default(now()) @db.Timestamp(0)
  
  id_usuario    Int
  usuario       usuario  @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)
}

model estado {
  id_estado     Int         @id @default(autoincrement()) @map("id_estado")
  nombre_estado String      @db.VarChar(50)
  descripcion   String?     @db.VarChar(255)

  // Relación
  tickets       ticket[]
}

// =====================================================================
//                       MODELOS CLAVE DE NEGOCIO
// ====================================================================

model categoria {
  id_categoria     Int         @id @default(autoincrement()) @map("id_categoria")
  nombre_categoria String      @unique @db.VarChar(100)
  prioridad        String      @db.VarChar(10)
  sla_horas        Int

  // Clave de Asignación Automática
  id_area_default Int         @map("id_area_default")
  area_default    area        @relation(fields: [id_area_default], references: [id_area])

  tickets          ticket[]
}

model pasajero {
  id_pasajero   Int         @id @default(autoincrement()) @map("id_pasajero")
  nombre        String      @db.VarChar(100)
  documento_id  String      @unique @db.VarChar(50) 
  info_contacto String?     @db.VarChar(255)

  tickets       ticket[]
}


model ticket {
  id_ticket                 Int         @id @default(autoincrement()) @map("id_ticket")
  titulo                    String      @db.VarChar(150)
  descripcion               String      @db.Text
  fecha_creacion            DateTime    @default(now()) @db.Timestamp(0)
  fecha_resolucion          DateTime?   @db.Timestamp(0)
  fecha_limite_sla          DateTime?   @db.Timestamp(0)

  // id_usuario_responsable ahora es opcional. NULO = Ticket disponible en el área.
  id_usuario_creador        Int         @map("id_usuario_creador")
  id_usuario_responsable    Int?        @map("id_usuario_responsable") // Opcional: El operador que tomó el ticket
  id_area_asignada          Int         @map("id_area_asignada")
  id_estado                 Int         @map("id_estado")

  id_categoria              Int         @map("id_categoria")
  id_pasajero               Int?        @map("id_pasajero")

  creador                   usuario     @relation("Creador", fields: [id_usuario_creador], references: [id_usuario])
  responsable               usuario?    @relation("Responsable", fields: [id_usuario_responsable], references: [id_usuario])
  area_asignada             area        @relation(fields: [id_area_asignada], references: [id_area])
  estado                    estado      @relation(fields: [id_estado], references: [id_estado])

  categoria_info            categoria @relation(fields: [id_categoria], references: [id_categoria])
  pasajero_info             pasajero? @relation(fields: [id_pasajero], references: [id_pasajero])

  comentarios               comentario[]
  evidencias                evidencia[]
  historial                 historial_ticket[]
  liberaciones_registro     liberacion_ticket[] // Registro de liberaciones (Junior -> Senior)
  solicitudes_cambio_area   solicitud_cambio_area[] // Solicitudes de cambio de área (Senior -> Admin)
}

// NUEVA TABLA: Solicitud de Cambio de Área (Requiere Aprobación)
model solicitud_cambio_area {
  id_solicitud            Int       @id @default(autoincrement()) @map("id_solicitud")
  fecha_solicitud         DateTime  @default(now()) @db.Timestamp(0)
  fecha_respuesta         DateTime? @db.Timestamp(0)
  motivo                  String    @db.Text
  estado_solicitud        String    @default("PENDIENTE") @db.VarChar(20) // PENDIENTE, APROBADA, RECHAZADA

  // Claves Foráneas
  id_ticket               Int       @map("id_ticket")
  id_usuario_solicitante  Int       @map("id_usuario_solicitante") // Siempre un Senior
  id_usuario_aprobador    Int?      @map("id_usuario_aprobador")   // Administrador/Gerente
  id_area_origen          Int       @map("id_area_origen")
  id_area_destino         Int       @map("id_area_destino")

  // Relaciones
  ticket                  ticket    @relation(fields: [id_ticket], references: [id_ticket])
  solicitante             usuario   @relation("Solicitante", fields: [id_usuario_solicitante], references: [id_usuario])
  aprobador               usuario?  @relation("Aprobador", fields: [id_usuario_aprobador], references: [id_usuario])
  area_origen             area      @relation("AreaOrigen", fields: [id_area_origen], references: [id_area])
  area_destino            area      @relation("AreaDestino", fields: [id_area_destino], references: [id_area])

  @@map("solicitud_cambio_area")
}

// NUEVA TABLA: Registro de Liberación (Reasignación Junior a Senior - No requiere Aprobación)
model liberacion_ticket {
  id_liberacion     Int       @id @default(autoincrement()) @map("id_liberacion")
  fecha_liberacion  DateTime  @default(now()) @db.Timestamp(0)
  comentario_liberacion String? @db.Text // Comentario del Junior sobre por qué lo libera/sugiere

  // Claves Foráneas
  id_ticket         Int       @map("id_ticket")
  id_usuario_liberador Int    @map("id_usuario_liberador") // El Junior que lo libera

  // Relaciones
  ticket            ticket    @relation(fields: [id_ticket], references: [id_ticket])
  usuario_liberador usuario   @relation(fields: [id_usuario_liberador], references: [id_usuario])

  @@map("liberacion_ticket")
}

// ... (comentario, evidencia, historial_ticket, permiso, rol_permiso permanecen sin cambios)

model comentario {
  id_comentario  Int         @id @default(autoincrement()) @map("id_comentario")
  mensaje        String      @db.Text
  fecha_comentario DateTime @default(now()) @db.Timestamp(0)

  id_ticket      Int         @map("id_ticket")
  id_usuario     Int         @map("id_usuario")

  ticket         ticket      @relation(fields: [id_ticket], references: [id_ticket])
  usuario        usuario     @relation(fields: [id_usuario], references: [id_usuario])
}

model evidencia {
  id_evidencia  Int         @id @default(autoincrement()) @map("id_evidencia")
  url_archivo   String      @db.VarChar(512)
  tipo_mime     String      @db.VarChar(50) // Ej: "image/jpeg", "application/pdf"
  fecha_subida  DateTime    @default(now()) @db.Timestamp(0)

  id_ticket     Int         @map("id_ticket")
  ticket        ticket      @relation(fields: [id_ticket], references: [id_ticket])
}

model historial_ticket {
  id_historial  Int         @id @default(autoincrement()) @map("id_historial")
  fecha_cambio  DateTime    @default(now()) @db.Timestamp(0)

  id_ticket     Int         @map("id_ticket")
  ticket        ticket      @relation(fields: [id_ticket], references: [id_ticket])

  id_usuario    Int         @map("id_usuario")
  usuario       usuario     @relation(fields: [id_usuario], references: [id_usuario])

  tipo_cambio   String      @db.VarChar(50) // Ej: "CAMBIO_ESTADO", "ASIGNACION", "LIBERACION_JUNIOR_SENIOR"
  valor_anterior String?    @db.Text
  valor_nuevo   String?     @db.Text
}

// =====================================================================
//                       MODELOS DE SEGURIDAD
// ====================================================================

model permiso {
  id_permiso    Int         @id @default(autoincrement()) @map("id_permiso")
  nombre        String      @unique @db.VarChar(50)
  descripcion   String?     @db.VarChar(255)

  roles_permisos rol_permiso[]
}

model rol_permiso {
  id_rol_permiso Int         @id @default(autoincrement()) @map("id_rol_permiso")
  id_rol         Int         @map("id_rol")
  id_permiso     Int         @map("id_permiso")

  rol            rol         @relation(fields: [id_rol], references: [id_rol])
  permiso        permiso     @relation(fields: [id_permiso], references: [id_permiso])

  @@unique([id_rol, id_permiso], map: "UQ_RolPermiso")
  @@map("rol_permiso")
}